"use strict";!function(){angular.module("gen",["gen.config","gen.resources","gen.home","ui.router","ngSanitize"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("home")}]).run(["$log","$rootScope","$state",function(a,b,c){b.$on("$stateChangeStart",function(b,c,d){a.debug("state should change to state "+c.name)}),b.$on("$stateChangeSuccess",function(b,c,d,e){a.debug("state change with success from "+e.name+" to state "+c.name)})}])}(),angular.module("gen.resources",["gen.config","ngResource"]).factory("SimulationResource",["$resource","config",function(a,b){var c=9e3==location.port?"//localhost:8080":"";return a(b.SIMULATION_PATH+"/champions/:team",{},{getAllChampions:{method:"GET",isArray:!0,url:c+b.SIMULATION_PATH+"/champions"},getChampionForTeam:{method:"GET",isArray:!1,url:c+b.SIMULATION_PATH+"/champions/:team"}})}]),angular.module("gen.config",[]).config(["$provide",function(a){a.constant("config",{SIMULATION_PATH:"/simulation"})}]),angular.module("gen.car.directives",["gen.car.service","gen.floor.service"]).directive("car",["CarService","FloorService","$interval",function(a,b,c){function d(c){var d=new b2World(o,p),e=b.createFloor(q,d),f=a.createCar(c,o,d);return{world:d,carFilled:f,camera_y:0,camera_x:0,last_drawn_tile:0,floorTiles:e}}function e(a){return a.world.Step(1/m,20,20),a.carFilled.frames++,a.carFilled.checkDeath()?"stop":void 0}function f(a,b){var c=b.getContext("2d");c.clearRect(0,0,b.width,b.height),c.save(),g(a),c.translate(150-a.camera_x*s,120+a.camera_y*s),c.scale(s,-s),h(a,c),j(a,c),c.restore()}function g(a){var b=a.carFilled.getPosition(),c=a.camera_y-b.y,d=a.camera_x-b.x;a.camera_y-=r*c,a.camera_x-=r*d}function h(a,b){b.strokeStyle="#000",b.fillStyle="#666",b.lineWidth=1/s,b.beginPath();a:for(var c=Math.max(0,a.last_drawn_tile-20);c<a.floorTiles.length;c++)for(var d=a.floorTiles[c],e=d.GetFixtureList();e;e=e.m_next){var f=e.GetShape(),g=d.GetWorldPoint(f.m_vertices[0]).x;if(g>a.camera_x-5&&g<a.camera_x+10&&i(d,f.m_vertices,f.m_vertexCount,b),g>a.camera_x+10){a.last_drawn_tile=c;break a}}b.fill(),b.stroke()}function i(a,b,c,d){var e=a.GetWorldPoint(b[0]);d.moveTo(e.x,e.y);for(var f=1;c>f;f++){var g=a.GetWorldPoint(b[f]);d.lineTo(g.x,g.y)}d.lineTo(e.x,e.y)}function j(a,b){if(a.carFilled.alive){var c=a.carFilled.getPosition();if(!(c.x<a.camera_x-5)){b.strokeStyle="#444",b.lineWidth=1/s;for(var d=0;d<a.carFilled.wheels.length;d++)for(var e=a.carFilled.wheels[d],f=e.GetFixtureList();f;f=f.m_next){var g=f.GetShape(),h=Math.round(255-255*(f.m_density-u)/t).toString(),j="rgb("+h+","+h+","+h+")";l(e,g.m_p,g.m_radius,e.m_sweep.a,j,b)}var m=Math.round(100-70*((a.carFilled.car_def.chassis_density-v)/w)).toString()+"%";b.strokeStyle="#c44";var n=a.carFilled.car_def.team;b.fillStyle=k(n,m),b.beginPath();for(var e=a.carFilled.chassis,f=e.GetFixtureList();f;f=f.m_next){var g=f.GetShape();i(e,g.m_vertices,g.m_vertexCount,b)}b.fill(),b.stroke()}}}function k(a,b){var c;return c="BLUE"==a?"hsl(207,90%,"+b+")":"RED"==a?"hsl(4,90%,"+b+")":"GREEN"==a?"hsl(122,39%,"+b+")":"ORANGE"==a?"hsl(36,100%,"+b+")":"YELLOW"==a?"hsl(54,100%,"+b+")":"PURPLE"==a?"hsl(291,64%,"+b+")":"hsl(0,50%,"+b+")"}function l(a,b,c,d,e,f){var g=a.GetWorldPoint(b);f.fillStyle=e,f.beginPath(),f.arc(g.x,g.y,c,0,2*Math.PI,!0),f.moveTo(g.x,g.y),f.lineTo(g.x+c*Math.cos(d),g.y+c*Math.sin(d)),f.fill(),f.stroke()}var m=60,n=60,o=new b2Vec2(0,-9.81),p=!0,q=Math.seedrandom(),r=.05,s=70,t=100,u=40,v=30,w=300;return{restrict:"A",scope:{champion:"=champion"},link:function(b,g){var h=a.createCarDef(b.champion.carScore.car,b.champion.statistic.team),i=d(h),j=c(function(){var a=e(i);"stop"===a&&(b.stop=!0)},Math.round(1e3/m)),k=c(function(){f(i,g[0])},Math.round(1e3/n));b.$watch("stop",function(a,b){a&&(c.cancel(j),c.cancel(k))}),g.on("$destroy",function(){c.cancel(j),c.cancel(k),i.carFilled.kill()})}}}]),angular.module("gen.car.service",[]).service("CarService",["$q",function(a){function b(a,b,d){var e=new b2BodyDef;e.type=b2Body.b2_dynamicBody,e.position.Set(0,4);var f=d.CreateBody(e);return c(f,a[0],a[1],b),c(f,a[1],a[2],b),c(f,a[2],a[3],b),c(f,a[3],a[4],b),c(f,a[4],a[5],b),c(f,a[5],a[6],b),c(f,a[6],a[7],b),c(f,a[7],a[0],b),f.vertex_list=a,f}function c(a,b,c,d){var e=[];e.push(b),e.push(c),e.push(b2Vec2.Make(0,0));var f=new b2FixtureDef;f.shape=new b2PolygonShape,f.density=d,f.friction=10,f.restitution=.2,f.filter.groupIndex=-1,f.shape.SetAsArray(e,3),a.CreateFixture(f)}function d(a,b,c){var d=new b2BodyDef;d.type=b2Body.b2_dynamicBody,d.position.Set(0,0);var e=c.CreateBody(d),f=new b2FixtureDef;return f.shape=new b2CircleShape(a),f.density=b,f.friction=1,f.restitution=.2,f.filter.groupIndex=-1,e.CreateFixture(f),e}var e=0,f=60,g=10*f,h={};return h.createCarDef=function(a,b){var c={};return c.team=b,c.wheelCount=2,c.wheel_radius=[],c.wheel_density=[],c.wheel_vertex=[],c.wheel_radius[0]=a.wheel1.radius,c.wheel_density[0]=a.wheel1.density,c.wheel_vertex[0]=a.wheel1.vertex,c.wheel_radius[1]=a.wheel2.radius,c.wheel_density[1]=a.wheel2.density,c.wheel_vertex[1]=a.wheel2.vertex,c.chassis_density=a.chassi.densite,c.vertex_list=[],c.vertex_list.push(new b2Vec2(a.chassi.vecteurs[0],0)),c.vertex_list.push(new b2Vec2(a.chassi.vecteurs[2],a.chassi.vecteurs[3])),c.vertex_list.push(new b2Vec2(0,a.chassi.vecteurs[5])),c.vertex_list.push(new b2Vec2(a.chassi.vecteurs[6],a.chassi.vecteurs[7])),c.vertex_list.push(new b2Vec2(a.chassi.vecteurs[8],0)),c.vertex_list.push(new b2Vec2(a.chassi.vecteurs[10],a.chassi.vecteurs[11])),c.vertex_list.push(new b2Vec2(0,a.chassi.vecteurs[13])),c.vertex_list.push(new b2Vec2(a.chassi.vecteurs[14],a.chassi.vecteurs[15])),c},h.resetCar=function(a){a.health=g,a.maxPosition=0,a.maxPositiony=0,a.minPositiony=0,a.frames=0,a.alive=!0},h.createCar=function(a,c,f){var h={};h.health=g,h.maxPosition=0,h.maxPositiony=0,h.minPositiony=0,h.frames=0,h.car_def=a,h.alive=!0,h.chassis=b(a.vertex_list,a.chassis_density,f),h.wheels=[];for(var i=0;i<a.wheelCount;i++)h.wheels[i]=d(a.wheel_radius[i],a.wheel_density[i],f);for(var j=h.chassis.GetMass(),i=0;i<a.wheelCount;i++)j+=h.wheels[i].GetMass();for(var k=[],i=0;i<a.wheelCount;i++)k[i]=j*-c.y/a.wheel_radius[i];for(var l=new b2RevoluteJointDef,i=0;i<a.wheelCount;i++){var m=h.chassis.vertex_list[a.wheel_vertex[i]];l.localAnchorA.Set(m.x,m.y),l.localAnchorB.Set(0,0),l.maxMotorTorque=k[i],l.motorSpeed=-e,l.enableMotor=!0,l.bodyA=h.chassis,l.bodyB=h.wheels[i],f.CreateJoint(l)}return h.getPosition=function(){return h.chassis.GetPosition()},h.kill=function(){f.DestroyBody(h.chassis);for(var a=0;a<h.wheels.length;a++)f.DestroyBody(h.wheels[a])},h.checkDeath=function(){var a=h.getPosition();if(a.y>h.maxPositiony&&(h.maxPositiony=a.y),a.y<h.minPositiony&&(h.minPositiony=a.y),a.x>h.maxPosition+.02)h.health=g,h.maxPosition=a.x;else if(a.x>h.maxPosition&&(h.maxPosition=a.x),Math.abs(h.chassis.GetLinearVelocity().x)<.001&&(h.health-=5),h.health--,h.health<=0)return!0},h},h}]),angular.module("gen.floor.service",[]).service("FloorService",["$q",function(a){function b(a,b,d){var g=new b2BodyDef;g.position.Set(a.x,a.y);var h=d.CreateBody(g),i=new b2FixtureDef;i.shape=new b2PolygonShape,i.friction=.5;var j=[];j.push(new b2Vec2(0,0)),j.push(new b2Vec2(0,-f)),j.push(new b2Vec2(e,-f)),j.push(new b2Vec2(e,0));var k=new b2Vec2(0,0),l=c(j,k,b);return i.shape.SetAsArray(l),h.CreateFixture(i),h}function c(a,b,c){for(var d=[],e=0;e<a.length;e++){var f={};f.x=Math.cos(c)*(a[e].x-b.x)-Math.sin(c)*(a[e].y-b.y)+b.x,f.y=Math.sin(c)*(a[e].x-b.x)+Math.cos(c)*(a[e].y-b.y)+b.y,d.push(f)}return d}var d=200,e=1.5,f=.15,g={};return g.createFloor=function(a,c){var e=null,f=new b2Vec2(-5,0),g=[];Math.seedrandom(a);for(var h=0;d>h;h++){e=b(f,1.5*(3*Math.random()-1.5)*h/d,c),g.push(e);var i=e.GetFixtureList(),j=e.GetWorldPoint(i.GetShape().m_vertices[3]);f=j}return g},g}]),angular.module("gen.home",["ui.router","gen.home.service","gen.car.directives","gen.resources"]).config(["$stateProvider",function(a){a.state("home",{url:"/home",templateUrl:"scripts/app/home/home-tpl.html",controller:"HomeController"})}]).controller("HomeController",["$scope","ChampionsService","SimulationResource",function(a,b,c){function d(){c.getAllChampions().$promise.then(function(b){a.champions=b})}function e(){a.champions=[],b.connect()}function f(){a.champions=[],b.disconnect()}e(),a.connect=e,a.disconnect=f,a.retrieveChampions=d,a.connected=!1,b.receive().then(null,null,function(b){_.remove(a.champions,function(a){return a.statistic.team==b.champion.statistic.team}),a.champions.push(b.champion)}),a.$on("$destroy",function(){b.disconnect()})}]),angular.module("gen.home.service",[]).service("ChampionsService",["$q","$log",function(a,b){var c={},d=a.defer(),e={client:null,stomp:null},f=[],g=9e3==location.port?"//localhost:8080":"";c.SOCKET_URL=g+"/status/champions",c.CHAMPIONS_TOPIC="/topic/champions",c.CHAMPIONS_BROKER="/app/status/champions",c.receive=function(){return d.promise},c.send=function(a){var b=Math.floor(1e6*Math.random());e.stomp.send(c.CHAMPIONS_BROKER,{priority:9},JSON.stringify({message:a,id:b})),f.push(b)};var h=function(){b.info("close websocket")},i=function(a){var b=JSON.parse(a),c={champion:b};return _.some(f,c.id)&&(c.self=!0,f=_.remove(f,c.id)),c},j=function(a){e.stomp.subscribe(c.CHAMPIONS_TOPIC,function(a){d.notify(i(a.body))})};return c.connect=function(){e.client||(e.client=new SockJS(c.SOCKET_URL),e.stomp=Stomp.over(e.client),e.stomp.connect({},j),e.stomp.onclose=h)},c.disconnect=function(){e.stomp&&(e.stomp.disconnect(),e={client:null,stomp:null})},c}]);